# 艺人管理系统 - 工单系统迭代计划

## 一、项目现状分析

### 1.1 现有技术栈
- **后端框架**: Flask 3.0.0
- **数据库**: MySQL 8.0
- **前端**: HTML + JavaScript + CSS
- **现有功能**: 艺人管理、项目管理、活动管理、基础跟进记录

### 1.2 现有跟进记录功能
- 表名: `artist_follow_ups`
- 核心字段: `id`, `artist_id`, `content`, `operator`, `created_at`
- 功能局限性: 缺少分类、优先级、状态管理、协作功能

## 二、迭代目标

基于工单系统迭代方案，**采用方案二：标准工单系统**，实现完整的工单生命周期管理，包括：

1. ✅ 工单管理（分类、优先级、状态流转、指派）
2. ✅ 协作功能（评论、操作日志）
3. ✅ 统计分析
4. ✅ 附件支持
5. ✅ 工单编号自动生成

## 三、迭代计划

### 3.1 总体时间安排
- **开发周期**: 5天
- **开始时间**: 2025-12-31
- **结束时间**: 2026-01-04

### 3.2 详细开发计划

#### **Day 1: 数据库准备（0.5天）**

| 任务编号 | 任务描述 | 负责人 | 完成标准 |
|---------|---------|--------|----------|
| 1.1     | 创建工单主表 `work_tickets` | 后端开发 | 表结构正确创建，索引合理 |
| 1.2     | 创建工单评论表 `ticket_comments` | 后端开发 | 表结构正确创建，索引合理 |
| 1.3     | 创建工单操作日志表 `ticket_logs` | 后端开发 | 表结构正确创建，索引合理 |
| 1.4     | 实现工单编号生成逻辑 | 后端开发 | 能自动生成格式为 `WT + 日期 + 4位序号` 的工单编号 |

#### **Day 2: 后端开发 - 工单基础功能（2天）**

| 任务编号 | 任务描述 | 负责人 | 完成标准 |
|---------|---------|--------|----------|
| 2.1     | 实现工单CRUD接口 | 后端开发 | 支持创建、查询、更新、删除工单 |
| 2.2     | 实现工单状态流转接口 | 后端开发 | 支持状态从待处理→处理中→已完成→已关闭的流转 |
| 2.3     | 实现工单指派功能 | 后端开发 | 支持将工单指派给特定用户 |
| 2.4     | 实现工单评论接口 | 后端开发 | 支持添加、查询工单评论 |
| 2.5     | 实现工单操作日志记录 | 后端开发 | 所有工单操作都有日志记录 |

#### **Day 3: 后端开发 - 高级功能（1天）**

| 任务编号 | 任务描述 | 负责人 | 完成标准 |
|---------|---------|--------|----------|
| 3.1     | 实现多条件筛选接口 | 后端开发 | 支持按艺人、类型、状态、优先级、指派人、时间范围筛选 |
| 3.2     | 实现工单统计接口 | 后端开发 | 支持统计总数、待处理、处理中、已完成等状态的工单数量 |
| 3.3     | 实现附件上传功能 | 后端开发 | 支持工单和评论的附件上传 |
| 3.4     | 集成现有艺人信息 | 后端开发 | 工单能关联到具体艺人，显示艺人基本信息 |

#### **Day 4: 前端开发 - 页面实现（1天）**

| 任务编号 | 任务描述 | 负责人 | 完成标准 |
|---------|---------|--------|----------|
| 4.1     | 实现工单列表页面 | 前端开发 | 支持筛选、搜索、排序，显示工单基本信息 |
| 4.2     | 实现工单详情页面 | 前端开发 | 显示工单详细信息、评论、操作日志，支持状态更新和指派 |
| 4.3     | 实现统计看板页面 | 前端开发 | 显示工单统计数据、图表 |
| 4.4     | 集成到艺人详情页 | 前端开发 | 在艺人详情页添加"工单记录"Tab，显示该艺人的工单列表 |

#### **Day 5: 测试与优化（0.5天）**

| 任务编号 | 任务描述 | 负责人 | 完成标准 |
|---------|---------|--------|----------|
| 5.1     | 功能测试 | 测试人员 | 所有功能正常工作，无明显bug |
| 5.2     | 兼容性测试 | 测试人员 | 支持主流浏览器（Chrome、Firefox、Safari） |
| 5.3     | 性能优化 | 后端开发 | 接口响应时间<1秒，页面加载流畅 |
| 5.4     | 文档更新 | 后端开发 | 更新API文档和使用说明 |

## 四、技术实现细节

### 4.1 数据库表结构

#### 工单主表 `work_tickets`
```sql
CREATE TABLE `work_tickets` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `ticket_no` VARCHAR(20) NOT NULL COMMENT '工单编号: WT202512310001',
  `artist_id` INT(11) NOT NULL COMMENT '关联艺人',
  `title` VARCHAR(200) NOT NULL COMMENT '工单标题',
  `description` TEXT COMMENT '工单描述',
  `ticket_type` ENUM('沟通', '对接', '投诉', '需求', '问题', '其他') DEFAULT '沟通',
  `priority` ENUM('低', '中', '高', '紧急') DEFAULT '中',
  `status` ENUM('待处理', '处理中', '已完成', '已关闭', '已取消') DEFAULT '待处理',
  `creator_id` INT(11) NOT NULL COMMENT '创建人ID',
  `assigned_to` VARCHAR(50) DEFAULT NULL COMMENT '指派人',
  `due_date` DATETIME DEFAULT NULL COMMENT '截止日期',
  `completed_at` TIMESTAMP NULL COMMENT '完成时间',
  `attachment_path` VARCHAR(500) DEFAULT NULL COMMENT '附件路径',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_ticket_no` (`ticket_no`),
  KEY `idx_artist_id` (`artist_id`),
  KEY `idx_status` (`status`),
  KEY `idx_priority` (`priority`),
  KEY `idx_type` (`ticket_type`),
  KEY `idx_assigned_to` (`assigned_to`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_ticket_artist` FOREIGN KEY (`artist_id`) REFERENCES `artists` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工单主表';
```

#### 工单评论表 `ticket_comments`
```sql
CREATE TABLE `ticket_comments` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `ticket_id` INT(11) NOT NULL COMMENT '工单ID',
  `commenter_id` INT(11) NOT NULL COMMENT '评论人ID',
  `commenter_name` VARCHAR(50) NOT NULL COMMENT '评论人姓名',
  `content` TEXT NOT NULL COMMENT '评论内容',
  `attachment_path` VARCHAR(500) DEFAULT NULL COMMENT '附件路径',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_ticket_id` (`ticket_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_comment_ticket` FOREIGN KEY (`ticket_id`) REFERENCES `work_tickets` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工单评论表';
```

#### 工单操作日志表 `ticket_logs`
```sql
CREATE TABLE `ticket_logs` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `ticket_id` INT(11) NOT NULL COMMENT '工单ID',
  `operator_id` INT(11) NOT NULL COMMENT '操作人ID',
  `operator_name` VARCHAR(50) NOT NULL COMMENT '操作人姓名',
  `action` VARCHAR(50) NOT NULL COMMENT '操作类型: created/updated/assigned/commented/completed/closed',
  `field_changed` VARCHAR(50) DEFAULT NULL COMMENT '变更字段',
  `old_value` VARCHAR(500) DEFAULT NULL COMMENT '旧值',
  `new_value` VARCHAR(500) DEFAULT NULL COMMENT '新值',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_ticket_id` (`ticket_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_log_ticket` FOREIGN KEY (`ticket_id`) REFERENCES `work_tickets` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工单操作日志表';
```

### 4.2 API接口设计

| 接口路径 | 方法 | 功能描述 |
|---------|------|----------|
| `/api/tickets` | POST | 创建工单 |
| `/api/tickets` | GET | 获取工单列表（支持筛选） |
| `/api/tickets/{ticket_id}` | GET | 获取工单详情 |
| `/api/tickets/{ticket_id}` | PUT | 更新工单信息 |
| `/api/tickets/{ticket_id}` | DELETE | 删除工单 |
| `/api/tickets/{ticket_id}/status` | PUT | 更新工单状态 |
| `/api/tickets/{ticket_id}/assign` | PUT | 指派工单 |
| `/api/tickets/{ticket_id}/comments` | POST | 添加工单评论 |
| `/api/tickets/{ticket_id}/comments` | GET | 获取工单评论 |
| `/api/tickets/{ticket_id}/logs` | GET | 获取工单操作日志 |
| `/api/tickets/stats` | GET | 获取工单统计数据 |
| `/api/tickets/stats/my` | GET | 获取我的工单统计 |

### 4.3 前端页面设计

1. **工单列表页面**
   - 筛选器：艺人、类型、状态、优先级、指派人、时间范围
   - 工单表格：编号、标题、艺人、类型、优先级、状态、创建时间、操作
   - 状态标签颜色区分：待处理-灰色、处理中-蓝色、已完成-绿色、已关闭-深灰

2. **工单详情页面**
   - 基本信息区：标题、编号、状态、优先级、类型
   - 关联艺人信息：艺人卡片（头像、姓名、联系方式）
   - 责任信息：创建人、指派人、创建时间、截止日期
   - 工单描述：富文本展示
   - 附件区：附件列表和下载
   - 评论区：时间线形式展示评论
   - 操作区：更新状态、指派、关闭、添加评论

3. **统计看板页面**
   - 顶部统计卡片：总数、待处理、处理中、已完成、已关闭
   - 图表区域：类型分布饼图、优先级柱状图、时间趋势折线图
   - 近期工单列表

4. **艺人详情页集成**
   - 添加"工单记录"Tab
   - 显示该艺人的工单列表
   - 快速创建工单按钮

## 五、测试计划

### 5.1 功能测试
- 工单创建、查询、更新、删除
- 工单状态流转
- 工单指派功能
- 工单评论功能
- 多条件筛选
- 统计数据准确性

### 5.2 兼容性测试
- 主流浏览器：Chrome、Firefox、Safari
- 不同屏幕尺寸：桌面端、平板端

### 5.3 性能测试
- 工单列表加载时间 < 1秒
- 工单详情加载时间 < 0.5秒
- 并发请求处理能力

## 六、风险评估与应对措施

| 风险项 | 影响程度 | 应对措施 |
|-------|---------|----------|
| 数据库结构变更影响现有功能 | 高 | 做好数据备份，编写回滚脚本 |
| 前端页面与现有设计风格不一致 | 中 | 参考现有页面设计，保持风格统一 |
| 工单编号生成冲突 | 低 | 实现原子操作，确保编号唯一性 |
| 统计数据准确性问题 | 中 | 编写详细的测试用例，验证统计结果 |

## 七、验收标准

1. ✅ 所有工单功能正常运行
2. ✅ 工单状态流转符合预期
3. ✅ 工单操作有完整日志记录
4. ✅ 统计数据准确无误
5. ✅ 前端页面美观、易用
6. ✅ 接口响应速度快
7. ✅ 代码符合项目规范
8. ✅ 文档完整

